# 2 Implement Core API Client

## Description

Build the MarktDeApiClient class with all verified API endpoints for messaging functionality. This is the foundation for all communication with markt.de's backend.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-06 15:00:00 | Created | N/A | not_started | Task created | System |

## Requirements

Implement the core API client based on the successfully tested API patterns:
- Get threads from both normal (basis) and premium groups
- Retrieve messages for specific conversations
- Send text messages to conversations
- Check for real-time updates
- Extract user IDs from various sources

_Requirements: 13 (API interception and direct communication)_

## Implementation Plan

### 1. Create MarktDeApiClient Class
```javascript
class MarktDeApiClient {
  constructor() {
    this.baseUrl = '/benutzer/postfach.htm';
    this.ownUserId = null;
  }
}
```

### 2. Implement Core API Methods
Based on verified working patterns:

**getThreads()**: 
- Endpoint: `GET /benutzer/postfach.htm?ajaxCall=getThreads&userId={ownUserId}&page=0&messageState=ALL`
- Returns both `normalGroup` (basis) and `premiumGroup` (premium) threads
- Extract participant data and advert titles

**getMessages()**:
- Endpoint: `GET /benutzer/postfach.htm?ajaxCall=getMessages&threadId={threadId}&userId={ownUserId}`
- Returns complete conversation history with participant info

**submitTextMessage()**:
- Endpoint: `POST /benutzer/postfach.htm`
- Body: `ajaxCall=submitMessage&threadId={threadId}&userId={ownUserId}&message={urlEncodedMessage}`
- Handle URL encoding of message text

**checkForUpdates()**:
- Endpoint: `GET /benutzer/postfach.htm?ajaxCall=checkForUpdates&userId={ownUserId}&threadId={threadId}&lastMessageDate={timestamp}&lastSeenMessageDate={timestamp}&lastUpdate={timestamp}`
- Returns unread counts for both normal and premium groups

### 3. Implement Utility Methods
- `extractUserIdFromSession()`: Get from `window.clsyDataLayer[0].loggedInUserId`
- `extractUserIdFromProfileUrl()`: Parse `userId,{ID}` pattern from URLs
- `classifyThreadsByGroup()`: Separate normalGroup vs premiumGroup responses

### 4. Add Error Handling
- Network error handling with retry logic
- API response validation
- Authentication error detection
- Rate limiting awareness

### 5. Add Request Headers
Based on successful API tests:
```javascript
headers: {
  'Accept': 'application/json',
  'X-Requested-With': 'XMLHttpRequest',
  'Content-Type': 'application/x-www-form-urlencoded' // for POST requests
}
```

## Test Plan

### Success Criteria
- All API methods return expected data structures
- Text message sending works correctly
- Thread classification separates basis/premium chats properly
- User ID extraction works from all sources
- Error handling gracefully manages API failures

### Test Scenarios
1. **Thread Retrieval**: Call getThreads() and verify both groups are returned
2. **Message Reading**: Get messages for known thread ID (Anna-Fae: 2193521669)
3. **Message Sending**: Send test message and verify delivery
4. **User ID Extraction**: Test all three extraction methods
5. **Error Handling**: Test with invalid parameters and network failures

### Test Data
Use verified working data from API testing:
- Thread ID: `2193521669` (Anna-Fae conversation)
- Own User ID: `39826031`
- Other User ID: `39793847` (Anna-Fae)

## Verification

- [ ] getThreads() returns both normalGroup and premiumGroup data
- [ ] getMessages() retrieves complete conversation history
- [ ] submitTextMessage() successfully sends messages
- [ ] checkForUpdates() returns current unread counts
- [ ] User ID extraction works from session and URLs
- [ ] Thread classification correctly identifies basis vs premium
- [ ] Error handling manages network and API failures
- [ ] All requests include proper headers and authentication

## Files Modified

- `marktde-ai-chat-bot/src/api/MarktDeApiClient.js` (new)
- `marktde-ai-chat-bot/src/utils/UserIdExtractor.js` (new)
- `marktde-ai-chat-bot/src/models/ApiResponse.js` (new)

[Back to task list](./tasks.md)