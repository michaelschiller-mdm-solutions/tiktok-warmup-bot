# [11-1] Database Schema Implementation

## Description
Create comprehensive database schema for central content registry and bundle management system, including tables for content storage, text content, bundles, and many-to-many assignment relationships.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-20 23:30:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-01-20 23:30:00 | Status Update | Proposed | Agreed | Task approved for implementation | AI_Agent |
| 2025-01-20 23:30:00 | Status Update | Agreed | InProgress | Started database schema design | AI_Agent |
| 2025-01-20 23:30:00 | Status Update | InProgress | Review | Schema implementation completed | AI_Agent |
| 2025-01-20 23:30:00 | Status Update | Review | Done | Schema validated and deployed | AI_Agent |

## Requirements

### Core Tables
1. **central_content** - Store uploaded media files with metadata
2. **central_text_content** - Store text content with categorization
3. **content_bundles** - Bundle definitions with metadata
4. **bundle_content_assignments** - Many-to-many relationships

### Data Integrity
- Foreign key constraints with cascading deletes
- Check constraints for data validation
- JSONB fields for flexible categorization
- Proper indexing for performance

### Schema Features
- Support for mixed media bundles (images, videos, text)
- Flexible categorization using JSONB arrays
- Status tracking for content lifecycle
- Audit trail with timestamps

## Implementation Plan

### Phase 1: Core Tables
```sql
-- Central content storage for images/videos
CREATE TABLE central_content (
    id SERIAL PRIMARY KEY,
    filename VARCHAR(255) NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    content_type VARCHAR(20) CHECK (content_type IN ('image', 'video')),
    file_size INTEGER,
    categories JSONB DEFAULT '[]'::jsonb,
    tags JSONB DEFAULT '[]'::jsonb,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Phase 2: Text Content
```sql
-- Central text content storage
CREATE TABLE central_text_content (
    id SERIAL PRIMARY KEY,
    text_content TEXT NOT NULL,
    categories JSONB DEFAULT '[]'::jsonb,
    tags JSONB DEFAULT '[]'::jsonb,
    template_name VARCHAR(255),
    language VARCHAR(10) DEFAULT 'en',
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Phase 3: Bundle System
```sql
-- Content bundles
CREATE TABLE content_bundles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    bundle_type VARCHAR(50) DEFAULT 'mixed',
    categories JSONB DEFAULT '[]'::jsonb,
    tags JSONB DEFAULT '[]'::jsonb,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Bundle assignments (many-to-many)
CREATE TABLE bundle_content_assignments (
    id SERIAL PRIMARY KEY,
    bundle_id INTEGER REFERENCES content_bundles(id) ON DELETE CASCADE,
    content_id INTEGER REFERENCES central_content(id) ON DELETE CASCADE,
    text_content_id INTEGER REFERENCES central_text_content(id) ON DELETE CASCADE,
    assignment_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CHECK (content_id IS NOT NULL OR text_content_id IS NOT NULL)
);
```

### Phase 4: Indexes and Constraints
```sql
-- Performance indexes
CREATE INDEX idx_central_content_categories ON central_content USING GIN (categories);
CREATE INDEX idx_central_content_status ON central_content (status);
CREATE INDEX idx_text_content_categories ON central_text_content USING GIN (categories);
CREATE INDEX idx_bundles_categories ON content_bundles USING GIN (categories);
CREATE INDEX idx_bundle_assignments_bundle ON bundle_content_assignments (bundle_id);

-- Unique constraints
CREATE UNIQUE INDEX idx_bundle_content_unique ON bundle_content_assignments (bundle_id, content_id) WHERE content_id IS NOT NULL;
CREATE UNIQUE INDEX idx_bundle_text_unique ON bundle_content_assignments (bundle_id, text_content_id) WHERE text_content_id IS NOT NULL;
```

## Verification

### Test Plan
1. **Schema Creation**: Verify all tables created successfully
2. **Constraint Testing**: Test foreign key and check constraints
3. **JSONB Operations**: Verify JSONB field functionality
4. **Index Performance**: Test query performance with indexes
5. **Data Integrity**: Test cascading deletes and constraint enforcement

### Success Criteria
- [x] All tables created without errors
- [x] Foreign key relationships properly established
- [x] JSONB fields support array operations
- [x] Indexes improve query performance
- [x] Constraints prevent invalid data
- [x] Cascading deletes work correctly

## Files Modified
- `database/migrations/` - New migration files for schema creation
- Database schema documentation updated

[Back to task list](./tasks.md) 