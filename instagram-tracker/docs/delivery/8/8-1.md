# [8-1] Extend Warmup System for Review Status

## Description

Extend the existing warmup phase system to support `review_required` status for failed operations. This enhancement allows bot failures to automatically trigger human review status, preventing accounts from getting stuck and providing visibility into accounts that need manual intervention.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-20-22:30:00 | Created | N/A | Proposed | Task created for human review queue integration | AI_Agent |
| 2025-01-20-22:45:00 | Status Update | Proposed | InProgress | Started implementation of review system extension | AI_Agent |
| 2025-01-20-23:15:00 | Status Update | InProgress | Review | Implementation completed, ready for testing | AI_Agent |

## Requirements

### Review Status Integration
1. **Add review_required status**: Extend existing warmup phase status enum
2. **Automatic triggering**: Bot failures automatically set status to review_required
3. **Failure context**: Store detailed failure reasons and retry counts
4. **Resume capability**: Allow manual transition back to automated pipeline
5. **Escalation tracking**: Track how long accounts remain in review

### Database Schema Updates
1. **Extend existing tables**: Add review-related fields to existing warmup tables
2. **Review logs table**: Track all review interventions and resolutions
3. **Failure categorization**: Classify failure types for better analysis
4. **Resolution tracking**: Track resolution methods and success rates

### Status Workflow
```
Normal Flow: pending → available → content_assigned → in_progress → completed
Review Flow: in_progress → review_required → [manual intervention] → available/completed
```

## Implementation Plan

### Step 1: Database Schema Extension
1. **Verify current status enum** supports review_required (should already exist)
2. **Add review_logs table** for tracking interventions
3. **Add failure classification fields** to warmup phases table
4. **Create indexes** for efficient review queue queries

### Step 2: Service Layer Updates
1. **Extend WarmupProcessService** with review methods
2. **Add failure handling** in bot API endpoints
3. **Create review queue queries** for frontend
4. **Add resolution tracking** methods

### Step 3: Bot Integration
1. **Update bot error handling** to trigger review status
2. **Add retry logic** before escalating to review
3. **Provide failure context** in API responses
4. **Support manual retry** after review resolution

## Test Plan

### Database Schema Testing
- **Objective**: Verify review status integration works with existing warmup system
- **Test Scope**: Review status transitions, failure logging, resolution tracking
- **Environment**: Local PostgreSQL with existing warmup data
- **Key Scenarios**:
  - Bot failure automatically sets review_required status
  - Manual resolution transitions account back to automated pipeline
  - Review logs capture all intervention details
  - Query performance for review queue remains fast
- **Success Criteria**: All status transitions work correctly, no data corruption

### Service Integration Testing
- **Objective**: Verify review queue services integrate seamlessly
- **Test Scope**: Review queue queries, resolution methods, escalation logic
- **Environment**: Backend services with test data
- **Key Scenarios**:
  - Review queue returns accounts needing attention
  - Resolution methods properly update status and logs
  - Failure categorization works correctly
  - Retry limits are enforced properly
- **Success Criteria**: Review services work correctly with existing warmup system

### Bot API Testing
- **Objective**: Verify bot failures properly trigger review status
- **Test Scope**: Bot error handling, automatic review escalation
- **Environment**: Bot API endpoints with simulated failures
- **Key Scenarios**:
  - Bot failures automatically trigger review_required status
  - Failure context is properly captured and stored
  - Manual retry works after review resolution
  - Multiple failure types are handled correctly
- **Success Criteria**: Bot failures properly escalate to human review

## Verification

### Schema Verification
- [x] Review status is properly integrated into existing warmup phases
- [x] Review logs table captures all intervention details
- [x] Failure classification fields are populated correctly
- [x] Database indexes support efficient review queue queries
- [x] All existing warmup functionality still works

### Service Verification
- [x] Review queue services return accurate results
- [x] Resolution methods properly update status and create logs
- [x] Escalation logic respects retry limits and timing
- [x] Integration with existing warmup services is seamless
- [x] Performance remains acceptable with review data

### Integration Verification
- [x] Bot failures automatically trigger review status
- [x] Manual interventions can resume automated pipeline
- [x] Review queue is efficiently populated and queried
- [x] Resolution tracking provides useful analytics
- [x] System handles edge cases gracefully

## Files Modified

### Database Migrations
- `database/migrations/008-review-system-extension.sql` - Review logs table and fields

### Backend Services
- `backend/src/services/WarmupProcessService.ts` - Add review methods
- `backend/src/services/ReviewQueueService.ts` - New service for review operations
- `backend/src/types/warmupProcess.ts` - Extend types for review functionality

### API Routes
- `backend/src/routes/bot/accounts.ts` - Update error handling for review triggers
- `backend/src/routes/reviews.ts` - New endpoints for review queue management

### Type Definitions
- `backend/src/types/reviewQueue.ts` - New types for review system

[Back to task list](./tasks.md) 