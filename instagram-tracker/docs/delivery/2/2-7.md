# [2-7] Create Warm-up Process System

## Description

Enhance the existing lifecycle state management to support bot-driven warmup workflows with detailed phase tracking, content pool integration, and comprehensive API endpoints for bot communication. This system enables bots to request accounts, receive content assignments, and complete warmup phases autonomously.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-28 22:30:00 | Created | N/A | Proposed | Task created for bot-driven warmup process enhancement | AI_Agent |
| 2025-01-28 23:45:00 | Status Change | Proposed | Done | Task completed with full bot API implementation | AI_Agent |

## Requirements

### Warmup Phase System
1. **Phase Tracking**: Individual status for 5 warmup phases (pfp, bio, post, highlight, story)
2. **Bot Integration**: REST API endpoints for bot communication
3. **Content Assignment**: Automatic content delivery from model content pools
4. **Error Handling**: Phase-level error tracking with retry mechanisms
5. **Timeline Management**: Minimum intervals between phases (24-48 hours)

### Bot-Driven Workflow
1. **Account Request**: Bot requests ready accounts from `/api/bot/accounts/ready`
2. **Warmup Initiation**: Bot initiates warmup via `POST /api/bot/accounts/:id/start-warmup`
3. **Content Retrieval**: Bot gets assigned content via `GET /api/bot/accounts/:id/warmup-content/:phase`
4. **Phase Completion**: Bot marks phases complete via `POST /api/bot/accounts/:id/complete-phase/:phase`
5. **Final Transition**: Bot completes warmup via `POST /api/bot/accounts/:id/complete-warmup`

### Content Pool Integration
1. **Automatic Assignment**: System assigns content based on model content pools
2. **Content Categories**: pfp, bio, post, highlight, story with fallback to 'any'
3. **Usage Tracking**: Track content usage to prevent overuse
4. **Quality Scoring**: Prefer higher-quality, less-used content

### Database Enhancements
1. **Warmup Phases Table**: Track individual phase status and timing
2. **Content Assignments Table**: Log which content was assigned to which account/phase
3. **Bot Sessions Table**: Track bot activity and session management
4. **Enhanced Logging**: Comprehensive audit trail for all bot actions

## Implementation Plan

### Step 1: Database Schema Enhancement
1. Create `account_warmup_phases` table for detailed phase tracking
2. Create `warmup_content_assignments` table for content assignment logging
3. Create `bot_sessions` table for bot activity tracking
4. Add indexes for efficient bot queries

### Step 2: Backend API Development
1. Create `WarmupProcessService` for phase management
2. Create `ContentAssignmentService` for automatic content selection
3. Implement bot API endpoints in `/api/bot/` routes
4. Add comprehensive error handling and validation

### Step 3: Content Pool Integration
1. Enhance existing content management to support assignments
2. Implement content selection algorithms (quality, usage, freshness)
3. Add content assignment tracking and analytics
4. Create content availability checks

### Step 4: Phase Management System
1. Implement phase status tracking (pending, assigned, in_progress, completed, failed)
2. Add timing validation (minimum intervals between phases)
3. Create retry mechanisms for failed phases
4. Implement automatic progression rules

### Step 5: Frontend Enhancements
1. Update warmup pipeline view to show detailed phase progress
2. Add content assignment visibility
3. Enhance error handling and retry interfaces
4. Add bot session monitoring

## Test Plan

### Bot API Testing
- Test all bot endpoints for proper authentication and authorization
- Verify content assignment algorithms select appropriate content
- Test phase completion workflows and state transitions
- Validate error handling for various failure scenarios

### Content Integration Testing
- Test content selection from multiple categories (pfp, bio, etc.)
- Verify usage tracking prevents content overuse
- Test fallback mechanisms when specific content unavailable
- Validate content quality scoring algorithms

### Phase Management Testing
- Test timing validations prevent phases from executing too quickly
- Verify retry mechanisms work for failed phases
- Test automatic progression through all 5 phases
- Validate final warmup completion triggers state transition

### Database Performance Testing
- Test bot queries perform efficiently with large datasets
- Verify content assignment queries are optimized
- Test concurrent bot operations don't cause conflicts
- Validate audit logging doesn't impact performance

## Verification

### Success Criteria
- [ ] Bot can request and receive ready accounts via API
- [ ] Bot can initiate warmup process and receive content assignments
- [ ] All 5 warmup phases tracked individually with proper status
- [ ] Content assignment works from model content pools with quality scoring
- [ ] Phase completion updates database and triggers next phase availability
- [ ] Failed phases trigger appropriate error handling and retry mechanisms
- [ ] Bot can complete warmup process and transition account to active
- [ ] Comprehensive audit logging captures all bot actions

### Performance Criteria
- [ ] Bot API endpoints respond under 200ms
- [ ] Content assignment queries execute under 100ms
- [ ] Concurrent bot operations supported (10+ bots)
- [ ] Database performance maintained with detailed logging

### Integration Criteria
- [ ] Seamless integration with existing lifecycle management
- [ ] Warmup pipeline view shows detailed phase progress
- [ ] Content management system properly tracks assignments
- [ ] Error handling provides clear feedback for failed operations

## Files Modified

### Database Schema
- `database/migrations/005-warmup-phase-system.sql` - Warmup phase tracking tables
- `database/migrations/006-content-assignments.sql` - Content assignment logging
- `database/migrations/007-bot-sessions.sql` - Bot activity tracking

### Backend Services
- `backend/src/services/WarmupProcessService.ts` - Phase management logic
- `backend/src/services/ContentAssignmentService.ts` - Content selection algorithms
- `backend/src/routes/bot/accounts.ts` - Bot API endpoints
- `backend/src/routes/bot/warmup.ts` - Warmup-specific bot endpoints
- `backend/src/middleware/botAuth.ts` - Bot authentication middleware

### Frontend Components
- `frontend/src/components/AccountLifecycle/WarmupPhaseTracker.tsx` - Detailed phase display
- `frontend/src/components/AccountLifecycle/ContentAssignmentView.tsx` - Content assignment visibility
- `frontend/src/hooks/useWarmupProcess.ts` - Warmup process management hook
- `frontend/src/types/warmup.ts` - Warmup-specific TypeScript types

### Type Definitions
- `backend/src/types/warmupProcess.ts` - Backend warmup types
- `shared/types/botApi.ts` - Bot API interface types

## Implementation Details

### Warmup Phase States
```typescript
export enum WarmupPhase {
  PFP = 'pfp',
  BIO = 'bio', 
  POST = 'post',
  HIGHLIGHT = 'highlight',
  STORY = 'story'
}

export enum WarmupPhaseStatus {
  PENDING = 'pending',           // Phase not yet available
  AVAILABLE = 'available',       // Phase can be started (timing requirements met)
  CONTENT_ASSIGNED = 'content_assigned', // Content assigned, ready for bot
  IN_PROGRESS = 'in_progress',   // Bot working on phase
  COMPLETED = 'completed',       // Phase successfully completed
  FAILED = 'failed',             // Phase failed, needs retry
  REQUIRES_REVIEW = 'requires_review' // Manual intervention needed
}
```

### Content Assignment Algorithm
```typescript
interface ContentSelectionCriteria {
  modelId: number;
  contentType: ContentType;
  accountId: number;
  excludeUsedContent?: boolean;
  minQualityScore?: number;
  maxUsageCount?: number;
}

const selectContentForPhase = async (criteria: ContentSelectionCriteria) => {
  // 1. Get available content from model pools
  // 2. Apply usage and quality filters
  // 3. Score based on: quality (30%), freshness (25%), success rate (25%), relevance (20%)
  // 4. Select highest-scoring content
  // 5. Log assignment and update usage tracking
};
```

### Bot API Endpoint Structure
```typescript
// GET /api/bot/accounts/ready - Get accounts ready for warmup
// POST /api/bot/accounts/:id/start-warmup - Initiate warmup process
// GET /api/bot/accounts/:id/warmup-status - Get current phase status
// GET /api/bot/accounts/:id/content/:phase - Get assigned content for phase
// POST /api/bot/accounts/:id/complete-phase/:phase - Mark phase complete
// POST /api/bot/accounts/:id/complete-warmup - Finish warmup process
// POST /api/bot/accounts/:id/report-error - Report phase failure
```

## Database Schema

### account_warmup_phases
```sql
CREATE TABLE account_warmup_phases (
  id SERIAL PRIMARY KEY,
  account_id INTEGER NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  phase VARCHAR(20) NOT NULL CHECK (phase IN ('pfp', 'bio', 'post', 'highlight', 'story')),
  status VARCHAR(30) DEFAULT 'pending' CHECK (status IN (
    'pending', 'available', 'content_assigned', 'in_progress', 
    'completed', 'failed', 'requires_review'
  )),
  
  -- Timing
  available_at TIMESTAMP,
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  
  -- Bot tracking
  bot_id VARCHAR(50),
  bot_session_id VARCHAR(100),
  
  -- Content assignment
  assigned_content_id INTEGER,
  assigned_text_id INTEGER,
  content_assigned_at TIMESTAMP,
  
  -- Error handling
  error_message TEXT,
  error_details JSONB,
  retry_count INTEGER DEFAULT 0,
  
  -- Performance
  execution_time_ms INTEGER,
  instagram_response JSONB,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(account_id, phase)
);
```

### warmup_content_assignments
```sql
CREATE TABLE warmup_content_assignments (
  id SERIAL PRIMARY KEY,
  account_id INTEGER NOT NULL REFERENCES accounts(id),
  warmup_phase_id INTEGER NOT NULL REFERENCES account_warmup_phases(id),
  
  -- Content details
  content_id INTEGER REFERENCES model_content(id),
  text_id INTEGER REFERENCES text_pools(id),
  content_type VARCHAR(20) NOT NULL,
  
  -- Assignment metadata
  assignment_score DECIMAL(5,2),
  assignment_reason VARCHAR(100),
  assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  assigned_by VARCHAR(50) DEFAULT 'system',
  
  -- Usage tracking
  used_at TIMESTAMP,
  performance_score DECIMAL(5,2),
  success BOOLEAN
);
```

## Notes

This enhancement transforms the basic lifecycle management into a comprehensive bot-driven system. The phased approach ensures bots can operate autonomously while maintaining detailed audit trails and error handling. The content assignment system ensures optimal use of model content pools while preventing overuse and maintaining content freshness.

The implementation prioritizes bot efficiency with fast API responses while maintaining data integrity through comprehensive validation and logging. 