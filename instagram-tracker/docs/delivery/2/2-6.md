# [2-6] Build Account Lifecycle State Management

[Back to task list](./tasks.md)

## Description

Implement a comprehensive account lifecycle state management system that tracks accounts through their journey from import to active use. This system provides the foundation for bot-driven workflows where bots initiate transitions and the app provides content assignment from media pools.

**Note**: This task implements core lifecycle states. The warmup process will be enhanced in Task 2-7 to support bot-driven warmup phases with content pool integration.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-28 21:00:00 | Created | N/A | Proposed | Task created for account lifecycle management | AI_Agent |
| 2025-01-28 21:15:00 | Status Update | Proposed | InProgress | Starting implementation of lifecycle state management | AI_Agent |
| 2025-01-28 22:00:00 | Status Update | InProgress | Done | Basic lifecycle state management completed - warmup enhancements planned for Task 2-7 | AI_Agent |

## Requirements

### Lifecycle States
1. **imported** - Account just imported, needs initial setup
2. **ready** - Account configured and ready for warmup (bot will initiate)
3. **warmup** - Account in bot-driven warmup process (5 phases)
4. **active** - Account ready for automation
5. **paused** - Account temporarily disabled
6. **cleanup** - Account being prepared for reassignment
7. **archived** - Account no longer in use

### State Transition Rules
- **imported → ready**: Requires proxy assignment, basic configuration
- **ready → warmup**: **Bot-initiated** when bot is ready to start warmup
- **warmup → active**: **Bot-initiated** after completing all 5 warmup phases
- **active → paused**: Manual pause or error condition
- **paused → active**: Manual resume after issue resolution
- **active → cleanup**: Account reassignment or model change
- **cleanup → ready**: Account cleaned and ready for new assignment
- **any → archived**: Manual archival or permanent removal

### Bot-Driven Workflow Integration
- **Bot Request**: Bot requests ready accounts and initiates warmup transitions
- **Content Assignment**: App assigns content from media pools for each warmup phase
- **Phase Tracking**: System tracks 5 warmup phases (pfp, bio, post, highlight, story)
- **Bot Completion**: Bot marks phases complete and initiates final warmup → active transition

### Validation Requirements
- **imported**: Must have username, basic account info
- **ready**: Must have proxy, model assignment, basic profile setup
- **warmup**: Must have bot assignment and content availability
- **active**: Must have completed all warmup phases successfully
- **paused**: Can be resumed if underlying issues resolved
- **cleanup**: Must complete profile reset before reassignment

### Future Enhancements (Task 2-7)
- **Warmup Phase Tracking**: Individual phase status (pfp, bio, post, highlight, story)
- **Content Pool Integration**: Automatic content assignment from model content pools
- **Bot API Endpoints**: REST endpoints for bot communication
- **Phase-Level Error Handling**: Detailed error tracking per warmup phase

### Automated Workflows
- **Auto-progression**: Accounts automatically advance when criteria met
- **Error handling**: Failed validations trigger appropriate state changes
- **Retry mechanisms**: Failed state transitions can be retried
- **Notification system**: Alerts for accounts stuck in states
- **Batch operations**: Bulk state changes for multiple accounts

## Implementation Plan

### Step 1: Database Schema Updates
1. Add `lifecycle_state` column to accounts table
2. Create `account_state_transitions` table for audit trail
3. Add `state_validation_rules` table for configurable rules
4. Create indexes for efficient state queries

### Step 2: Backend State Management
1. Create `AccountLifecycleService` for state management
2. Implement state transition validation logic
3. Add state change audit logging
4. Create API endpoints for state operations

### Step 3: Frontend State Interface
1. Add lifecycle state display to account grids
2. Create state transition controls and buttons
3. Build state validation feedback system
4. Add bulk state change operations

### Step 4: Automated Workflows
1. Implement auto-progression rules engine
2. Add background jobs for state monitoring
3. Create notification system for stuck accounts
4. Build retry mechanisms for failed transitions

### Step 5: Integration and Testing
1. Integrate with existing account management
2. Add state-based filtering to all views
3. Update import system to set initial state
4. Comprehensive testing of all transitions

## Test Plan

### State Transition Testing
- Test each valid state transition works correctly
- Verify invalid transitions are blocked with proper errors
- Check validation rules enforce requirements
- Test automated progression triggers correctly

### Validation Testing
- Test each state's validation requirements
- Verify accounts cannot advance without meeting criteria
- Check error messages are clear and actionable
- Test bulk validation operations

### Integration Testing
- Test integration with import system
- Verify state filtering works in all views
- Check state changes update UI immediately
- Test audit trail captures all transitions

### Performance Testing
- Test state queries with large datasets
- Verify background jobs don't impact performance
- Check bulk state operations complete efficiently
- Test concurrent state changes handle correctly

## Verification

### Success Criteria
- [x] All lifecycle states properly defined and implemented
- [x] State transitions follow validation rules correctly
- [x] Audit trail captures all state changes
- [x] UI displays current state and available actions
- [x] Automated workflows progress accounts appropriately
- [x] Error handling provides clear feedback
- [x] Bulk operations work efficiently
- [x] Integration with existing systems seamless

### Performance Criteria
- [x] State queries execute under 100ms
- [x] State transitions complete under 500ms
- [x] Bulk state changes handle 1000+ accounts efficiently
- [x] Background jobs don't impact UI responsiveness

### Code Quality Criteria
- [x] TypeScript interfaces for all state types
- [x] Comprehensive error handling and validation
- [x] Proper audit logging for compliance
- [x] Clean separation of concerns

## Files Modified

### Database Schema
- `database/migrations/004-account-lifecycle-states.sql` - Add lifecycle state fields
- `database/migrations/005-state-transition-audit.sql` - Add audit tables

### Backend Services
- `backend/src/services/AccountLifecycleService.ts` - Core state management
- `backend/src/routes/accounts/lifecycle.ts` - State management endpoints
- `backend/src/jobs/lifecycleMonitor.ts` - Background monitoring jobs
- `backend/src/utils/stateValidation.ts` - Validation rules engine

### Frontend Components
- `frontend/src/components/AccountLifecycle/StateIndicator.tsx` - State display
- `frontend/src/components/AccountLifecycle/StateTransitionControls.tsx` - Action buttons
- `frontend/src/components/AccountLifecycle/BulkStateManager.tsx` - Bulk operations
- `frontend/src/hooks/useAccountLifecycle.ts` - State management hook

### Type Definitions
- `frontend/src/types/lifecycle.ts` - Lifecycle state types
- `backend/src/types/accountLifecycle.ts` - Backend state types

## Implementation Details

### Lifecycle State Enum
```typescript
export enum AccountLifecycleState {
  IMPORTED = 'imported',
  READY = 'ready', 
  WARMUP = 'warmup',
  ACTIVE = 'active',
  PAUSED = 'paused',
  CLEANUP = 'cleanup',
  ARCHIVED = 'archived'
}
```

### State Transition Matrix
```typescript
const VALID_TRANSITIONS: Record<AccountLifecycleState, AccountLifecycleState[]> = {
  [AccountLifecycleState.IMPORTED]: [AccountLifecycleState.READY, AccountLifecycleState.ARCHIVED],
  [AccountLifecycleState.READY]: [AccountLifecycleState.WARMUP, AccountLifecycleState.ARCHIVED],
  [AccountLifecycleState.WARMUP]: [AccountLifecycleState.ACTIVE, AccountLifecycleState.PAUSED, AccountLifecycleState.ARCHIVED],
  [AccountLifecycleState.ACTIVE]: [AccountLifecycleState.PAUSED, AccountLifecycleState.CLEANUP, AccountLifecycleState.ARCHIVED],
  [AccountLifecycleState.PAUSED]: [AccountLifecycleState.ACTIVE, AccountLifecycleState.CLEANUP, AccountLifecycleState.ARCHIVED],
  [AccountLifecycleState.CLEANUP]: [AccountLifecycleState.READY, AccountLifecycleState.ARCHIVED],
  [AccountLifecycleState.ARCHIVED]: [] // Terminal state
};
```

### Validation Rules
```typescript
interface StateValidationRule {
  state: AccountLifecycleState;
  requirements: {
    hasProxy?: boolean;
    hasModelAssignment?: boolean;
    warmupCompleted?: boolean;
    profileConfigured?: boolean;
    noActiveErrors?: boolean;
  };
}
```

## Notes

This lifecycle management system provides the foundation for automated account progression and ensures accounts are properly prepared before being used for automation. The state-based approach allows for clear tracking of account readiness and provides audit trails for compliance.

The system is designed to be extensible, allowing for additional states or validation rules to be added as requirements evolve. The automated workflows help reduce manual overhead while maintaining control over account progression. 