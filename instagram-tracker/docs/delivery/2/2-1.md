# [2-1] Extend Database Schema for Account Fields

[Back to task list](./tasks.md)

## Description

Extend the database schema to support all required account fields from the Excel specification including content type, location details, account relationships, and dynamic column support. This task adds the missing fields to the accounts table and creates supporting tables for relationships and custom columns.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-06-10 20:15:00 | Created | N/A | Proposed | Task file created | System |

## Requirements

### Core Field Extensions
- Add `content_type` field (VARCHAR) for account content categorization
- Add `campus` field (VARCHAR) for campus/location targeting
- Add `niche` field (VARCHAR) for industry/niche categorization  
- Add `cta_text` field (TEXT) for call-to-action content
- Add `mother_account_id` field (INTEGER) for account hierarchy
- Extend existing location field for Stadt support

### Dynamic Column Support
- Create `dynamic_columns` table for user-defined columns
- Create `account_dynamic_data` table for storing custom field values
- Support for TEXT, NUMBER, DATE, BOOLEAN column types
- Column ordering and visibility preferences

### Relationship Management
- Create `account_relationships` table for mother-slave hierarchies
- Enhance `model_target_follows` with follow-back duration tracking
- Add follow-back timestamp and duration calculation triggers

### Data Migration
- Migrate existing account data without loss
- Provide default values for new fields
- Update existing sample data to include new fields
- Ensure backward compatibility with existing API

## Implementation Plan

### Phase 1: Schema Analysis and Design
1. Review current accounts table structure
2. Analyze existing data for migration requirements
3. Design new tables with proper constraints and indexes
4. Create migration scripts with rollback capability

### Phase 2: Database Updates
1. Create migration SQL files in numbered sequence
2. Add new columns to accounts table with appropriate defaults
3. Create dynamic_columns table with validation rules
4. Create account_dynamic_data table with foreign key constraints
5. Create account_relationships table for hierarchy management
6. Update model_target_follows with follow-back duration tracking

### Phase 3: Data Population
1. Update sample data to include new fields
2. Create default dynamic columns for common use cases
3. Test data integrity and constraint validation
4. Verify performance impact of new schema

### Phase 4: API Updates
1. Update TypeScript interfaces for new fields
2. Modify existing API endpoints to handle new fields
3. Add validation for new field types
4. Update error handling for constraint violations

## Test Plan

### Schema Validation
- Verify all new columns are created with correct data types
- Test foreign key constraints and cascading deletes
- Validate default values are applied correctly
- Check indexes are created for performance

### Data Migration Testing
- Test migration with existing sample data
- Verify no data loss during schema updates
- Test rollback procedures work correctly
- Validate backward compatibility

### Performance Testing
- Measure query performance impact of new schema
- Test bulk operations with new fields
- Verify index effectiveness for common queries
- Check memory usage with large datasets

### Integration Testing
- Test new fields work with existing API endpoints
- Verify TypeScript compilation with updated interfaces
- Test database connection pool handling
- Validate transaction handling with new tables

## Verification

- [ ] All new database tables created successfully
- [ ] New columns added to accounts table with proper constraints
- [ ] Sample data updated to include new fields
- [ ] Migration scripts tested and validated
- [ ] API endpoints handle new fields without errors
- [ ] TypeScript interfaces updated and compiling
- [ ] Performance benchmarks meet requirements (< 100ms for typical queries)
- [ ] All existing tests pass with new schema

## Files Modified

### Database Files
- `database/init/01-schema.sql` - Core schema definitions
- `database/init/02-sample-data.sql` - Updated sample data
- `database/migrations/003-extend-accounts.sql` - Migration script
- `database/migrations/004-dynamic-columns.sql` - Dynamic columns
- `database/migrations/005-account-relationships.sql` - Relationships

### Backend Files
- `backend/src/types/account.ts` - TypeScript interfaces
- `backend/src/routes/accounts.ts` - API endpoint updates
- `backend/src/validation/accountValidation.ts` - Field validation
- `backend/src/database.ts` - Connection and query helpers

### Documentation
- `docs/database-schema.md` - Updated schema documentation
- `docs/api-reference.md` - API endpoint documentation 