# [2-1] Extend Database Schema for Account Fields

[Back to task list](./tasks.md)

## Description

Extend the database schema to support all required account fields including content type, location details, account relationships, dynamic column support, proxy management, cost tracking, and advanced analytics. This comprehensive update transforms the database to handle Adspower profiles, proxy credentials, cost analysis, and performance metrics required for the advanced analytics dashboard.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-06-10 20:15:00 | Created | N/A | Proposed | Task file created | System |
| 2025-01-27 22:00:00 | Status Update | Proposed | InProgress | Extended scope to include proxy management, cost tracking, and advanced analytics | AI_Agent |
| 2025-01-27 22:45:00 | Status Update | InProgress | Review | Database schema extensions completed, ready for API integration and testing | AI_Agent |
| 2025-01-27 23:30:00 | Status Update | Review | Done | Task completed - database extensions, TypeScript interfaces, and backend API routes fully implemented | AI_Agent |

## Requirements

### Core Field Extensions
- Add `content_type` field (VARCHAR) for account content categorization
- Add `campus` field (VARCHAR) for campus/location targeting
- Add `niche` field (VARCHAR) for industry/niche categorization  
- Add `cta_text` field (TEXT) for call-to-action content
- Add `mother_account_id` field (INTEGER) for account hierarchy
- Extend existing location field for Stadt support

### Dynamic Column Support
- Create `dynamic_columns` table for user-defined columns
- Create `account_dynamic_data` table for storing custom field values
- Support for TEXT, NUMBER, DATE, BOOLEAN column types
- Column ordering and visibility preferences

### Proxy Management Integration
- Add `proxy_host`, `proxy_port`, `proxy_username`, `proxy_password` fields (encrypted)
- Add `adspower_profile_id`, `cupid_profile_id` fields for integration
- Add `proxy_provider`, `proxy_status`, `proxy_location` fields
- Create `proxy_providers` table for provider management
- Add proxy status monitoring and health check fields

### Cost Tracking System
- Create `cost_categories` table (Cupid, Proxies, VPS, Accounts, iPhones, Tunnelbear, Chatter, Model, Payment Provider)
- Create `model_costs` table for per-model cost allocation
- Create `account_costs` table for per-account cost breakdown
- Add cost calculation fields for profit margin analysis
- Create cost history tracking for trend analysis

### Advanced Analytics Enhancement
- Enhance `model_target_follows` with follow-back rate tracking
- Add `followed_back_at`, `follow_back_duration` fields
- Create `conversion_events` table for follow-to-subscription tracking
- Add performance metrics fields for account analysis
- Create aggregated analytics views for dashboard efficiency

### Relationship Management
- Create `account_relationships` table for mother-slave hierarchies
- Enhance `model_target_follows` with comprehensive follow-back tracking
- Add follow-back timestamp and duration calculation triggers
- Create performance ranking and comparison tables

### Data Migration
- Migrate existing account data without loss
- Provide default values for new fields including proxy and cost data
- Update existing sample data to include new fields and relationships
- Ensure backward compatibility with existing API
- Create secure migration for sensitive proxy credentials

## Implementation Plan

### Phase 1: Schema Analysis and Design
1. Review current accounts table structure
2. Analyze existing data for migration requirements
3. Design new tables with proper constraints and indexes
4. Create migration scripts with rollback capability

### Phase 2: Database Updates
1. Create migration SQL files in numbered sequence
2. Add new columns to accounts table with appropriate defaults
3. Create dynamic_columns table with validation rules
4. Create account_dynamic_data table with foreign key constraints
5. Create account_relationships table for hierarchy management
6. Update model_target_follows with follow-back duration tracking

### Phase 3: Data Population
1. Update sample data to include new fields
2. Create default dynamic columns for common use cases
3. Test data integrity and constraint validation
4. Verify performance impact of new schema

### Phase 4: API Updates
1. Update TypeScript interfaces for new fields
2. Modify existing API endpoints to handle new fields
3. Add validation for new field types
4. Update error handling for constraint violations

## Test Plan

### Schema Validation
- Verify all new columns are created with correct data types
- Test foreign key constraints and cascading deletes
- Validate default values are applied correctly
- Check indexes are created for performance

### Data Migration Testing
- Test migration with existing sample data
- Verify no data loss during schema updates
- Test rollback procedures work correctly
- Validate backward compatibility

### Performance Testing
- Measure query performance impact of new schema
- Test bulk operations with new fields
- Verify index effectiveness for common queries
- Check memory usage with large datasets

### Integration Testing
- Test new fields work with existing API endpoints
- Verify TypeScript compilation with updated interfaces
- Test database connection pool handling
- Validate transaction handling with new tables

## Verification

- [x] All new database tables created successfully
- [x] New columns added to accounts table with proper constraints
- [x] Sample data updated to include new fields
- [x] Migration scripts tested and validated
- [x] TypeScript interfaces updated and compiling
- [x] API endpoints handle new fields without errors
- [x] Performance benchmarks meet requirements (< 100ms for typical queries)
- [x] All existing tests pass with new schema
- [x] Database migrations executed successfully
- [x] Sample data loads without errors

## Files Modified

### Database Files
- `database/migrations/003-extend-accounts-comprehensive.sql` - Comprehensive account extensions
- `database/migrations/004-cost-tracking-system.sql` - Cost tracking tables and views
- `database/migrations/005-advanced-analytics.sql` - Analytics enhancements and triggers
- `database/migrations/run-migrations.sql` - Migration runner script
- `database/init/03-extended-sample-data.sql` - Comprehensive sample data with all new fields

### Frontend Type Definitions
- `frontend/src/types/accounts.ts` - Complete account interfaces with proxy/cost/analytics
- `frontend/src/types/analytics.ts` - Cost tracking and analytics type definitions

### Backend Files (Completed)
- `backend/src/routes/accounts.ts` - API endpoint updates for new fields (COMPLETED)
- `backend/src/routes/analytics.ts` - Enhanced analytics endpoints (COMPLETED)
- `frontend/src/services/api.ts` - Updated API client with all new endpoints (COMPLETED)

### Documentation (To Be Created)
- `docs/database-schema.md` - Updated schema documentation
- `docs/api-reference.md` - API endpoint documentation 