# [4-4] Create E2E test for account setup

## Description
This task is to create an end-to-end (E2E) test that validates the entire account setup workflow. This test will simulate the frontend's call to the `account_setup.js` script and verify that all steps are executed correctly. Given the complexity and dependencies (requires a real iPhone and email account), this test may be semi-automated.

[Back to task list](./tasks.md)

## Status History
| Timestamp           | Event Type | From Status | To Status | Details           | User |
| ------------------- | ---------- | ----------- | --------- | ----------------- | ---- |
| 2024-07-22 10:03:00 | Created    | N/A         | Proposed  | Task file created | AI   |

## Requirements
- A new test script, `test/integration/account_setup.test.js`, will be created.
- The test will use mock versions of `AutomationBridge` and `EmailTokenFetcher` to avoid actual device/network interaction during standard test runs.
- The mocks should verify that the correct methods are called in the right sequence.
- An optional "live" test mode can be included, which uses the real services and requires configuration via environment variables (e.g., `TEST_ACCOUNT_SETUP_CONFIG`).

## Implementation Plan (Mocked Test)
1.  **Create Test File**: Create `test/integration/account_setup.test.js`.
2.  **Mock Dependencies**:
    - Use `jest.mock()` to mock `AutomationBridge` and `EmailTokenFetcher`.
    - Create mock implementations that return successful promises and record calls (e.g., using `jest.fn()`).
3.  **Import Services**: Import the `AccountSetupService` and the mocked dependencies.
4.  **Write Test Case**:
    - `it('should run the full account setup sequence correctly', async () => { ... })`
    - Instantiate the `AccountSetupService` with the mocked bridge and fetcher.
    - Define a sample `setupConfig` object.
    - Call `await service.run(setupConfig)`.
5.  **Assert Calls**:
    - `expect(bridge.selectContainer).toHaveBeenCalledWith(config.containerNumber)`.
    - `expect(bridge.setClipboard).toHaveBeenCalledWith(config.username)`.
    - `expect(bridge.executeScript).toHaveBeenCalledWith('enter_email.lua')`.
    - ...and so on for every step in the sequence.
    - Verify the calls were made in the correct order.

## Implementation Plan (Live Test - Optional)
1.  Add a `describe.skipIf(!process.env.TEST_ACCOUNT_SETUP_CONFIG)` block.
2.  Inside, create a test that reads the config from the environment variable.
3.  This test will use the *real* services without mocks.
4.  It will execute the `account_setup.js` script as a child process and check for a successful exit code and JSON output.

## Verification
- The mocked integration test runs successfully as part of the normal test suite.
- The test correctly verifies the sequence of operations in the `AccountSetupService`.
- The test fails if the sequence is incorrect.

## Files Modified
- `test/integration/account_setup.test.js` (created) 