# [4-1] Create `AccountSetupService` orchestrator

## Description
This task involves creating a new service class, `AccountSetupService`, responsible for orchestrating the entire automated Instagram account setup workflow. This service will act as a state machine, calling the appropriate methods on the `AutomationBridge` and the new `EmailTokenFetcher` to execute the sequence of setup steps.

[Back to task list](./tasks.md)

## Status History
| Timestamp           | Event Type | From Status | To Status | Details           | User |
| ------------------- | ---------- | ----------- | --------- | ----------------- | ---- |
| 2024-07-22 10:00:00 | Created    | N/A         | Proposed  | Task file created | AI   |

## Requirements
- The service must be a class that can be instantiated (e.g., `new AccountSetupService(automationBridge, emailFetcher)`).
- It must expose a public method, `async run(setupConfig)`, to start the process.
- `setupConfig` object will contain: `{ containerNumber, username, password, emailConfig: { host, user, pass } }`.
- The service should log each major step of the process (e.g., "Selecting container...", "Entering username...").
- The service must use the existing `AutomationBridge` for all iPhone interactions (selecting containers, setting clipboard, executing scripts).
- It must correctly call the `EmailTokenFetcher` service to retrieve the verification token.

## Implementation Plan
1.  Create a new file: `services/AccountSetupService.js`.
2.  Define the `AccountSetupService` class.
    - The constructor will accept an instance of `AutomationBridge` and `EmailTokenFetcher`.
3.  Implement the `async run(setupConfig)` method.
    - **Step 1: Select Container**: Call `this.bridge.selectContainer(setupConfig.containerNumber)`.
    - **Step 2: Enter Username**:
        - Call `this.bridge.setClipboard(setupConfig.username)`.
        - Call `this.bridge.executeScript('enter_email.lua')`.
    - **Step 3: Enter Password & Login**:
        - Call `this.bridge.setClipboard(setupConfig.password)`.
        - Call `this.bridge.executeScript('enter_password_and_login.lua')`.
    - **Step 4: Fetch Verification Token**:
        - Call `this.emailFetcher.fetchLatestToken(setupConfig.emailConfig)`.
    - **Step 5: Enter Token**:
        - Call `this.bridge.setClipboard(token)`.
        - Call `this.bridge.executeScript('enter_verification_token.lua')`.
    - **Step 6: Skip Onboarding**:
        - Call `this.bridge.executeScript('skip_onboarding.lua')`.
4.  Add robust error handling with `try...catch` blocks for each step to ensure failures are caught and logged.
5.  Export the class: `module.exports = AccountSetupService;`.

## Verification
- The `AccountSetupService.js` file is created in the `services` directory.
- The class and its `run` method are implemented as per the plan.
- The service correctly sequences the calls to its dependencies (`AutomationBridge`, `EmailTokenFetcher`).

## Files Modified
- `services/AccountSetupService.js` (created) 