# [4-2] Create `EmailTokenFetcher` utility

## Description
This task is to create a small, reusable utility service, `EmailTokenFetcher`, that can connect to a specified IMAP email server, search for the most recent Instagram verification email, and extract a 6-digit verification token from its body.

[Back to task list](./tasks.md)

## Status History
| Timestamp           | Event Type | From Status | To Status | Details           | User |
| ------------------- | ---------- | ----------- | --------- | ----------------- | ---- |
| 2024-07-22 10:01:00 | Created    | N/A         | Proposed  | Task file created | AI   |

## Requirements
- The utility must be in a new file: `services/EmailTokenFetcher.js`.
- It must depend on an IMAP library like `imap-simple`. This dependency should be added to `package.json`.
- It must expose an `async fetchLatestToken(config)` method.
- The `config` object will be `{ host, port: 993, user, password, tls: true }`.
- The method should poll the inbox every 5 seconds for up to 60 seconds.
- It must search for unread emails from a known Instagram address (e.g., `security@mail.instagram.com`).
- It must parse the email body and find a 6-digit number, which is assumed to be the token. A regex like `/\b(\d{6})\b/` should be used.
- It must handle IMAP connection errors gracefully.
- If no token is found within the timeout period, it should throw an error.

## Implementation Plan
1.  **Add Dependency**: Run `npm install imap-simple`. Add `imap-simple` to `package.json`.
2.  **Create File**: Create `services/EmailTokenFetcher.js`.
3.  **Implement Class**:
    - Define the `EmailTokenFetcher` class.
    - Implement the `async fetchLatestToken(config)` method.
4.  **Polling Logic**:
    - Inside `fetchLatestToken`, use a `while` loop or `setInterval` with a timeout to poll for the email.
5.  **IMAP Logic**:
    - Connect to the IMAP server using `imap-simple`.
    - Open the `INBOX`.
    - Search for unread emails with criteria `['UNSEEN', ['FROM', 'security@mail.instagram.com']]`.
    - If found, fetch the body of the most recent one.
    - Apply the regex `/\b(\d{6})\b/` to the body to extract the token.
    - If a token is found, resolve the promise and return it.
6.  **Error Handling**: Wrap the logic in `try...catch` and ensure the IMAP connection is closed in a `finally` block.
7.  **Export**: Export the class.

## Verification
- The `imap-simple` package is added to `package.json`.
- The `EmailTokenFetcher.js` file is created.
- The `fetchLatestToken` method successfully connects to a test IMAP account, finds an email, and extracts a token.
- The method correctly times out and throws an error if no email is found.

## Files Modified
- `services/EmailTokenFetcher.js` (created)
- `package.json` (modified) 